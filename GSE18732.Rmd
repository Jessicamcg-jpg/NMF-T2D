---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(GEOquery)
library(Biobase)
library(mclust)
library(clue)
library(pdfCluster)
library(NMF)
library(funtimes)
library(ggplot2)
library(plotrix)
library(fpc)
library(edgeR)
library(dplyr)
 
```

```{r}
 
gse <- getGEO("GSE18732", GSEMatrix = TRUE)
length(gse)  
gse_data <- gse[[1]]

# 1. Expression matrix 
exprSet9 <- exprs(gse_data)
head(exprSet9[, 1:5])
dim(exprSet9)
# 2. Sample metadata 
sample_metaGSE18732 <- pData(gse_data)
head(sample_metaGSE18732)

# 3. Gene annotations 
gene_infoGSE18732 <- fData(gse_data)
head(gene_infoGSE18732)

```

```{r}
write.csv(sample_metaGSE18732,file = "sample_meta18732.csv", row.names = TRUE )
sample_metaGSE18732 <- pData(gse[[1]])

gene_infoGSE18732<- fData(gse[[1]])

```
 



```{r}
# Ensure sample and gene names match
all(colnames(exprSet9) == rownames(sample_metaGSE18732))  
all(rownames(exprSet9) == rownames(gene_infoGSE18732))     
 
pheno <- AnnotatedDataFrame(sample_metaGSE18732) 
feature <- AnnotatedDataFrame(gene_infoGSE18732)

eset <- ExpressionSet(assayData = exprSet9,
                      phenoData = pheno,
                      featureData = feature)
dim(eset) 

cpm_mat <- cpm(exprSet9)
keep_genes <- rowSums(cpm_mat > 1) >= round(0.5 * ncol(exprSet9))
filtered_counts <- exprSet9[keep_genes, ]

# Filter the matrix
 
dim(filtered_counts)
log_filtered <- log2(filtered_counts + 1)  # log transform before variance calcuate to avoid 0 values

gene_vars <- apply(log_filtered, 1, var) 
top_genes <- names(sort(gene_vars, decreasing = TRUE))[1:10000]
final_filtered <- filtered_counts[top_genes, ]
 
filtered_feature <- gene_infoGSE18732[rownames(final_filtered), , drop = FALSE]
filtered_features <- filtered_feature[rownames(final_filtered), , drop = FALSE]

filtered_phenos <- sample_metaGSE18732[colnames(final_filtered), , drop = FALSE]

pheno <- AnnotatedDataFrame(filtered_phenos)
feature <- AnnotatedDataFrame(filtered_features)

eset_filtered <- ExpressionSet(
  assayData = final_filtered,
  phenoData = pheno,
  featureData = feature
)
dim(final_filtered)
```
```{r}
 non_diabetic_samples <- filtered_phenos$`characteristics_ch1.5` == "dmverified: 0"
diabetic_samples <- filtered_phenos$`characteristics_ch1.5` == "dmverified: 1"

expr_non_diabetic <- final_filtered[, non_diabetic_samples]
expr_diabetic <-  final_filtered[, diabetic_samples]
log_nd <- log2(expr_non_diabetic + 1)
log_d <- log2(expr_diabetic + 1)
 
 
library(NMF)
nmf.options(parallel = FALSE)
 Estimate for non-diabetic
estim_nd <- nmf(log_nd, rank = 2:6, nrun = 10, method = "brunet", seed = 123)
plot(estim_nd)

# Estimate for diabetic
estim_d <- nmf(log_d , rank = 2:6, nrun = 30, method = "brunet", seed = 123)
plot(estim_d) 
 estim_d
 samples_nd <- colnames(log_nd )
annCol <- data.frame(t2dmknown = rep( "0", length(samples_nd)))
rownames(annCol) <- samples_nd

# Plot consensus map for estim_nd
consensusmap(estim_nd, annCol = annCol, labCol = NA, labRow = NA)

samples_d <- colnames(log_d )
annCol <- data.frame(t2dmknown = rep( "1", length(samples_d)))
rownames(annCol) <- samples_d

# Plot consensus map for estim_ d
consensusmap(estim_d, annCol = annCol, labCol = NA, labRow = NA)
```

 
```{r}
best_k2_model <- nmf(log_d, rank = 2, nrun = 50, method = "brunet", seed = 123)

# Extract basis and coef matrices
W <- basis(best_k2_model)
H <- coef(best_k2_model)

dim(W)  # genes x 2
dim(H)

top_genes_per_cluster <- apply(W, 2, function(x) {
  head(sort(x, decreasing = TRUE), 20)  # top 20 genes per cluster
})

# To see gene names (rownames(W)) for cluster 1 top genes
top_genes_cluster1 <- rownames(W)[order(W[,1], decreasing = TRUE)][1:20]

top_genes_cluster1
top_genes_cluster2 <- rownames(W)[order(W[,2], decreasing = TRUE)][1:20]

top_genes_cluster2
 
 
 
combined_top_genes <- unique(unlist(top_genes_per_cluster))
expr_subset <- log_d[combined_top_genes, ]
library(NMF)
#print(expr_subset)
aheatmap(expr_subset, scale = "row")
geo_accessions_in_heatmap <- colnames(expr_subset)
print(geo_accessions_in_heatmap)
Heatmap_metadata <- filtered_phenos[geo_accessions_in_heatmap, ]

# Save to CSV
write.csv(Heatmap_metadata,
          file = "heatmap18732_sample_metadata.csv")
```


```{r}
colnames(Heatmap_metadata)
Heatmap_metadata <- read.csv("heatmap18732_sample_metadata.csv", row.names=1)

H <-  coef(best_k2_model)
subtype_labels<- apply(H, 2, which.max)
Heatmap_metadata$subtype <- as.factor(subtype_labels)
sample_names <- colnames(H)
Heatmap_metadata$geo_accession <- rownames(Heatmap_metadata)
 library(tidyverse)
summary_table <- Heatmap_metadata %>%
  group_by(subtype) %>%
  summarise(
  n = n(),
  weight= mean(weight.ch1, na.rm = TRUE),
  FASTING_GLUCOSE= mean(glucose_0h.ch1, na.rm = TRUE),
 fasting_insulin2= mean(insulin_0h.ch1, na.rm = TRUE),
  fasting_insulin= mean(log_insulin_0h.ch1, na.rm = TRUE),
   
 # dm_debut=mean(dmdebut.ch1, na.rm=TRUE),
  HOMA2=mean(log_homa2_ir.ch1, na.rm = TRUE),
 #  HOMA2=mean(homa2_ir.ch1, na.rm = TRUE),
)
print(summary_table)
table(Heatmap_metadata$subtype)
table(Heatmap_metadata[, c("geo_accession", "subtype")])
```

```{r}
summary(aov(weight.ch1 ~ subtype, data = Heatmap_metadata))
summary(aov(glucose_0h.ch1 ~ subtype, data = Heatmap_metadata))
 
summary(aov(log_insulin_0h.ch1 ~ subtype, data = Heatmap_metadata))
 
summary(aov(dmdebut.ch1 ~ subtype, data = Heatmap_metadata))
summary(aov(log_homa2_ir.ch1 ~ subtype, data = Heatmap_metadata))
```
```{r}
library(broom)

meta_vars <- Heatmap_metadata %>% 
  select(where(is.numeric)) %>% 
  names()

results <- lapply(meta_vars, function(var) {
  formula <- as.formula(paste(var, "~ subtype"))
  res <- aov(formula, data = Heatmap_metadata)
  tidy(res)[1, c("term", "p.value")] %>% mutate(variable = var)
})

anova_results <- do.call(rbind, results) %>% 
  arrange(p.value)

print(anova_results)
```
 
```{r}
library(writexl)

 
subtype_list <- split(Heatmap_metadata, Heatmap_metadata$subtype)

 
write_xlsx(subtype_list, "Heatmap_subtypes.xlsx")
```
 
